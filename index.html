<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/logo-app.jpg" type="image/x-icon">
<title>Control de Pallets</title>
<style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --muted:#94a3b8;
  --text:#e5e7eb;
  --accent:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
  --card:#1f2937;
  --input:#0b1220;
 }
 *{box-sizing:border-box}
 body{margin:0;background:linear-gradient(180deg,#0b1020, #0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica Neue,Arial,Noto Sans}
 .wrap{max-width:1400px;margin:24px auto;padding:16px}
 h1{font-size:clamp(22px,3vw,32px);margin:0 0 12px}
 .sub{color:var(--muted);font-size:14px;margin-bottom:20px}
 .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr .8fr}
 @media (max-width:1200px){.grid{grid-template-columns:1fr}}
 .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
 .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
 input,select,button{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--input);color:var(--text);padding:12px 14px;font-size:16px}
 input,select{flex:1;min-width:160px}
 button{cursor:pointer;transition:.2s transform,.2s opacity}
 button:hover{transform:translateY(-1px)}
 button:disabled{opacity:0.5;cursor:not-allowed}
 .primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04120a;font-weight:700}
 .ghost{background:transparent}
 .warn{background:linear-gradient(90deg,#eab308,#f59e0b);border:none;color:#2a1d04;font-weight:700}
 .muted{color:var(--muted)}
 .list{display:grid;gap:8px;max-height:420px;overflow:auto;padding-right:4px}
 .item{display:grid;grid-template-columns:1fr 120px;gap:8px;align-items:center;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:10px 12px;border-radius:12px}
 .item > div:nth-child(2) { /* Ajuste para alinear botones y badges correctamente */
     display: flex;
     align-items: center;
     justify-content: flex-end; /* Alinea al final */
     gap: 8px; /* Espacio entre elementos */
     flex-wrap: wrap; /* Permite que los botones pasen a la siguiente línea si no caben */
 }
 .badge.en-proceso-alerta {
    display: block;          /* Aparece en línea separada, debajo del detalle */
    margin-top: 4px;         /* Separación del detalle */
    background: var(--danger); 
    color: var(--text); 
    border: 1px solid rgba(255, 255, 255, 0.1); 
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.85rem;
    word-break: break-word;  /* Texto largo se ajusta */
    max-width: 100%;         /* No sobresalga del contenedor */
}
 .badge-container { /* Contenedor específico para badges y botones */
     display: flex;
     align-items: center;
     justify-content: flex-end;
     gap: 8px;
     flex-wrap: wrap;
 }
 .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid rgba(255,255,255,.1);text-align:center;margin-left:6px}
 .empty{border:1px dashed rgba(255,255,255,.15);padding:20px;border-radius:12px;text-align:center}
 .kpi{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
 .kpi .box{background:var(--panel);border:1px solid rgba(255,255,255,.06);padding:12px 14px;border-radius:14px;min-width:150px}
 .small{font-size:12px;color:var(--muted)}
 .search{width:100%}
 .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
 #discountInfo, #taskGenInfo{margin-top:8px;font-size:12px;color:var(--muted)}
 
 /* --- NUEVOS ESTILOS PARA LA NAVEGACIÓN ENTRE PANTALLAS --- */
 .main-content > .ventana { /* Aplica a todas las secciones principales */
     display: none; /* Ocultas por defecto */
     margin-top: 20px; /* Espacio después de la cabecera */
 }
 .main-content > .ventana.visible {
     display: block; /* Se muestra si tiene la clase 'visible' */
 }
 /* Ajuste para que la card de KPIs no se oculte */
 .kpi {
     display: flex !important; /* Asegura que se muestre siempre */
 }
 /* Ajuste para que la navegación principal sí se vea siempre */
 nav { /* Selecciona la navegación directamente si solo hay una nav principal */
     display: flex !important; /* Asegura que la nav se muestre siempre */
     gap: 10px;
     margin-bottom: 20px;
 }
  /* Media query para pantalla celular */
   @media (max-width: 600px) {
     #filtroExcel {
       flex-direction: column;
       align-items: flex-start;
       gap: 8px;
       margin-left: 0;
     }
     #filtroExcel input,
     #filtroExcel button {
       width: 100%;
       box-sizing: border-box;
     }
     nav {
         flex-direction: column;
     }
   }
 
 /* Estilos para botones de navegación activos */
 nav button {
     transition: all 0.2s ease;
     opacity: 0.7;
     padding: 10px 16px;
 }
 nav button:hover {
     opacity: 1 !important;
 }
 nav button.active {
     opacity: 1;
     font-weight: bold;
     background: linear-gradient(90deg, #1e40af, #3b82f6);
     transform: translateY(-2px);
     box-shadow: 0 4px 8px rgba(0,0,0,0.2);
 }
 .ghost2 {  /* css que maneja los botones hoy ,acumulado ,descargar movimientos*/
    border: 1px solid #888;
    background: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin: 2px;
  }

  .ghost2.active {
    background: #333;
    color:#ddc01b;
  }
</style>
</head>
<body>
<div class="wrap">
    <h1>Control de Pallets</h1>
    <div class="kpi">
        <div class="box"><div class="small">Pendientes</div><div id="kpiPend">0</div></div>
        <!-- NUEVO KPI PARA CANCELADOS -->
        <!--<div class="box"><div class="small">Cancelados</div><div id="kpiCancel">0</div></div>-->
        <!-- FIN NUEVO KPI -->
        <div class="box"><div class="small">Procesados</div><div id="kpiDone">0</div></div>
        <div class="box"><div class="small">Última acción</div><div id="kpiLast">–</div></div>
    </div>

    <!-- Navegación Principal -->
    <nav>
        <!-- Usamos data-target para que el JS pueda leer qué ventana mostrar -->
        <button data-target="ingreso-pallet" class="active">Ingreso</button>
        <button data-target="generar-tarea">Generar Tarea</button>
        <button data-target="descontar-pallet">Descontar Pallet</button>
    </nav>
    
    <!-- *** SECCIÓN PARA FILTRO DE FECHA EN DESCAGA Y KPIs *** -->
    <div id="filtroExcel" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
        <!-- El input de fecha ahora está asociado directamente a los KPIs y a la descarga -->
        <label for="fechaInicioFiltro" class="muted" style="font-size: 14px;">Fecha:</label>
        <input type="date" id="fechaInicioFiltro" style="width: auto; padding: 6px 10px;background-color:gray;color: black;font-weight: bold;"/>
        
        <!-- Botones "Hoy" y "Acumulado" -->
        <button type="button" id="btnFechaHoy" class="ghost2">Hoy</button>
        <button type="button" id="btnAcumulado" class="ghost2">Acumulado</button>
        
        <!-- Botón de Descarga de Movimientos -->
        <button id="descargarExcelBtn" class="ghost2">Descargar Movimientos</button>
    </div>
    <!-- *** FIN SECCIÓN FILTRO FECHA *** -->

    <!-- Contenedor principal para las diferentes pantallas/ventanas -->
    <div class="main-content">

        <!-- Ventana 1: Ingreso de Pallet -->
        <div id="ingreso-pallet" class="ventana visible">
            <section class="card">
                <h3>Ingreso de pallet</h3>
                <form id="formAdd" class="row" autocomplete="off">
                    <input id="cantidad" type="number" placeholder="Cantidad" min="1" required />
                    <select id="cliente" required>
                        <option value="" disabled selected>Comitente</option>
                        <option value="ANDRATX">ANDRATX</option>
                        <option value="ANDROMACO">ANDROMACO</option>
                        <option value="ARGENTIA">ARGENTIA</option>
                        <option value="BEHRING">BEHRING</option>
                        <option value="BUYANOR">BUYANOR</option>
                        <option value="CEPAGE">CEPAGE</option>
                        <option value="DERMA">DERMA</option>
                        <option value="FERRING">FERRING</option>
                        <option value="FINADIET">FINADIET</option>
                        <option value="GEMA BIOTECH">GEMA BIOTECH</option>
                        <option value="IMA">IMA</option>
                        <option value="INSUMOS CAJAS">INSUMOS CAJAS</option>
                        <option value="CAJA PORTAFOLIO"> CAJA PORTAFOLIO</option>
                        <option value="CONSERVADORA 14 50MM">CONSERVADORA 14 50MM</option>
                        <option value="CONSERVADORA 14 30MM">CONSERVADORA 14 30MM</option>
                        <option value="INSUMO MANTA"> INSUMO MANTA</option>
                        <option value="GEL 300"> GEL 300</option>
                        <option value=" GEL 500"> GEL 500</option>
                        <option value="INSUMOS CINTAS">INSUMOS CINTAS</option>
                        <option value="INSUMOS FILM">INSUMOS FILM</option>
                        <option value="MAXVISION">MAXVISION</option>
                        <option value="MILLET">MILLET</option>
                        <option value="MJOHNSON">MJOHNSON</option>
                        <option value="NOVO">NOVO</option>
                        <option value="NOVOMM">NOVOMM</option>
                        <option value="NUTRIBABY">NUTRIBABY</option>
                        <option value="NUTRICION">NUTRICION</option>
                        <option value="POEN">POEN</option>
                        <option value="PRODUCTOS ESPECIALES">PRODUCTOS ESPECIALES</option>
                        <option value="PSICO">PSICO</option>
                        <option value="RAFFOMTV">RAFFOMTV</option>
                        <option value="RAFFO PSICO">RAFFO PSICO</option>
                        <option value="RAYMOS">RAYMOS</option>
                        <option value="RECKITT">RECKITT</option>
                        <option value="ROCHEDIA">ROCHEDIA</option>
                        <option value="ROEMMERS">ROEMMERS</option>
                        <option value="SANCOR">SANCOR</option>
                        <option value="SOPHIA">SOPHIA</option>
                        <option value="SUSTANCIAS CONTROLADAS">SUSTANCIAS CONTROLADAS</option>
                    </select>
                    <input id="UsuarioIngreso" type="text" placeholder="Usuario" required />
                    <button class="primary" type="submit">Cargar</button>
                </form>
                <div class="divider"></div>
                <input class="search" id="searchPend" placeholder="Filtrar por comitente..." />
                <div id="pendingList" class="list"></div> <!-- Lista para la primera solapa -->
            </section>
        </div>

        <!-- Ventana 2: Generar Tareas -->
        <div id="generar-tarea" class="ventana">
            <section class="card">
                <h3>Generar tareas de descuento</h3>
                <input class="search" id="searchDetail" placeholder="Filtrar por comitente..." />
                <div id="detailList" class="list"></div> <!-- Lista para la segunda solapa -->

                <!-- Sección de configuración de tarea (oculta por defecto) -->
                <div id="taskGenSection" style="display: none;">
                    <h4>Configurar tarea para: <span id="currentPalletClient"></span></h4>
                    <form id="formTaskGen" class="row" autocomplete="off">
                        <input id="taskCantidad" type="number" placeholder="Cantidad" min="1" required />
                        <input id="taskPasillo" placeholder="Pasillo" required />
                        <!-- *** SECCIÓN DE PRIORIDAD AGREGADA AQUÍ *** -->
                        <select id="prioridad" required>
                            <option value="" disabled selected>Seleccione la prioridad</option>
                            <option value="Alta">Alta</option>
                            <option value="Media">Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                        <!-- *** FIN SECCIÓN PRIORIDAD *** -->
                        <select id="ladoDEIngreso" required>
                            <option value="" disabled selected>Seleccione el lado de ingreso</option>
                            <option value="lado delantero">lado delantero</option>
                            <option value="lado trasero">lado trasero</option>
                        </select>

                        <button class="primary" type="submit">Continuar</button>
                        <button type="button" class="ghost" onclick="hideTaskGenSection()">Cancelar</button> <!-- Botón Cancelar -->
                    </form>
                    <div class="small muted" id="taskGenInfo"></div>
                </div>
            </section>
        </div>

        <!-- Ventana 3: Descontar Pallet -->
        <div id="descontar-pallet" class="ventana">
            <aside class="card">
                <h3>Descontar pallets</h3>
                <input class="search" id="searchTask" placeholder="Filtrar por cliente o pasillo..." />
                <div id="taskList" class="list"></div> <!-- Aquí se listarán las tareas disponibles para descontar -->

                <!-- Sección de descuento (oculta por defecto) -->
                <div id="discountSection" style="display: none;">
                    <h4>Descontar cantidad para: <span id="currentTaskClient"></span></h4>
                    <form id="formDiscount" class="row" autocomplete="off">
                        <input id="discountCantidad" type="number" placeholder="Cantidad a descontar" min="1" required />
                        
                        <!-- Botón Descontar (verde) -->
                        <button class="primary" type="submit">Descontar</button>
                        
                        <!-- Botón Cancelar (transparente/warn) -->
                        <button type="button" class="ghost warn" onclick="hideDiscountSection()">Cancelar</button>
                    </form>
                    <div class="small muted" id="discountInfo"></div>
                </div>
            </aside>
        </div>
    </div> <!-- Fin de .main-content -->
</div> <!-- Fin de .wrap -->

<!-- Plantillas para los elementos de la lista -->
<template id="tplItem">
    <div class="item">
        <div>
            <div class="client"></div>
            <div class="small"><span class="cantidad"></span></div>
        </div>
        <!-- El div para el badge y/o botones -->
        <div class="badge-container"></div>
        <!-- El botón para generar tarea se agregará dinámicamente en JS solo si es necesario -->
    </div>
</template>

<!-- Plantillas para los elementos de la lista de Tareas -->
<template id="tplTask">
    <div class="item">
        <div>
            <div class="client"></div>
            <div class="small"><span class="cantidad"></span></div>
        </div>
        <!-- Div para alinear los botones -->
        <div class="row" style="gap: 8px;">
            <button class="primary btnTask">Descontar</button>
            <button type="button" class="ghost warn">Desbloquear</button>
        </div>
    </div>
</template>

<!-- Script para la lógica del frontend -->
<script>
    
// --- CONFIGURACIÓN BÁSICA ---
const API_URL = '/api';

// Helpers para seleccionar elementos DOM
const $ = (s, p = document) => p.querySelector(s);
const $$ = (s, p = document) => p.querySelectorAll(s);

// Estado de la aplicación
let appState = {
    pendingPallets: [],
    tasks: [],
    currentTaskToDiscount: null,
    currentPalletToDiscountDirectly: null,
    currentPalletForTask: null
};

// --- Constantes de LocalStorage ---
const STORAGE_KEY = 'palletControl_selectedWindow'; // Para la ventana activa
const STORAGE_PROCESO = "tareasEnProceso"; // Para las tareas marcadas como "en proceso"

// --- Funciones de LocalStorage ---
function getProcesos() {
  return JSON.parse(localStorage.getItem(STORAGE_PROCESO)) || [];
}

function saveProcesos(procesos) {
  localStorage.setItem(STORAGE_PROCESO, JSON.stringify(procesos));
}

function marcarEnProceso(taskId) {
  let procesos = getProcesos();
  if (!procesos.includes(taskId)) {
    procesos.push(taskId);
    saveProcesos(procesos);
  }
}

function estaEnProceso(taskId) {
  return getProcesos().includes(taskId);
}

function finalizarProceso(taskId) {
  let procesos = getProcesos().filter(id => id !== taskId);
  saveProcesos(procesos);
}


// --- LÓGICA PARA MOSTRAR/OCULTAR VENTANAS ---
function mostrarVentana(idVentana) {
    // Ocultar todas las ventanas
    const ventanas = $$('.ventana');
    ventanas.forEach(ventana => {
        ventana.classList.remove('visible');
    });
    
    // Mostrar solo la ventana seleccionada
    const ventanaAMostrar = $(`#${idVentana}`);
    if (ventanaAMostrar) {
        ventanaAMostrar.classList.add('visible');
    }

    // Actualizar botones activos
    document.querySelectorAll('nav button[data-target]').forEach(button => {
        if (button.dataset.target === idVentana) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });

    // Guardar la selección en localStorage
    localStorage.setItem(STORAGE_KEY, idVentana);

    // Lógica para recargar datos según la ventana activa
    if (idVentana === 'ingreso-pallet') {
        fetchPendientes('pendingList');
        hideTaskGenSection();
        hideDiscountSection();
    }

    if (idVentana === 'generar-tarea') {
        fetchPendientes('detailList');
        hideTaskGenSection();
        hideDiscountSection();
    }
    
    if (idVentana === 'descontar-pallet') {
        fetchTasks();
        hideDiscountSection();
    }
}

// --- LÓGICA PARA CARGAR DATOS EN TABLAS Y SECCIONES ---
async function fetchPendientes(targetListId = 'pendingList') {
    const searchTerm = $('#' + (targetListId === 'detailList' ? 'searchDetail' : 'searchPend')).value;
    try {
        const response = await fetch(`${API_URL}/pendientes?search=${encodeURIComponent(searchTerm)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        appState.pendingPallets = data;
        renderPendientes(targetListId);
    } catch (error) {
        console.error(`Error fetching pending pallets for ${targetListId}:`, error);
        appState.pendingPallets = [];
        renderPendientes(targetListId);
    }
} //comentado para probar el codigo siguiente para pendiente general global sin importar fecha
/*async function fetchStatus(fechaInicio = null) { // Añadimos fechaInicio como parámetro opcional
    let url = `${API_URL}/status`;

    // Si hay fecha, la añadimos a la URL
    if (fechaInicio) {
        url += `?fechaInicio=${encodeURIComponent(fechaInicio)}`;
    }

    try {
        const response = await fetch(url);

        if (!response.ok) {
            const errorData = await response.json();

            // Si el error es de "fecha requerida", mostrar mensaje más específico.
            if (errorData.message && errorData.message.includes("Se requiere una fecha")) {
                console.error("Error al obtener status:", errorData.message);
                alert(`Error: ${errorData.message}`);
            } else {
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
        }

        const data = await response.json();

        // Actualizamos los KPIs en la página
        $('#kpiPend').textContent = data.pendientes;
        /* $('#kpiCancel').textContent = data.cancelados; */
        /*$('#kpiDone').textContent = data.descargados;
        $('#kpiLast').textContent = data.lastAction;

    } catch (error) {
        console.error('Error fetching status:', error);

        // En caso de error, mostrar ERR en los KPIs
        $('#kpiPend').textContent = 'ERR';
        /* $('#kpiCancel').textContent = 'ERR'; */
        /*$('#kpiDone').textContent = 'ERR';
        $('#kpiLast').textContent = 'ERR';
    }
}*/

async function fetchStatus(fechaInicio = null) {
    try {
        // --- Obtener total general de pendientes ---
        const responseGeneral = await fetch(`${API_URL}/status`);
        const dataGeneral = await responseGeneral.json();
        $('#kpiPend').textContent = dataGeneral.pendientes;

        // --- Obtener otros KPIs según la fecha (si se pasa) ---
        let url = `${API_URL}/status`;
        if (fechaInicio) {
            url += `?fechaInicio=${encodeURIComponent(fechaInicio)}`;
        }
        const response = await fetch(url);
        if (!response.ok) {
            const errorData = await response.json();
            if (errorData.message && errorData.message.includes("Se requiere una fecha")) {
                console.error("Error al obtener status:", errorData.message);
                alert(`Error: ${errorData.message}`);
            } else {
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
        }
        const data = await response.json();
        $('#kpiDone').textContent = data.descargados;
        $('#kpiLast').textContent = data.lastAction;

    } catch (error) {
        console.error('Error fetching status:', error);
        $('#kpiPend').textContent = 'ERR';
        $('#kpiDone').textContent = 'ERR';
        $('#kpiLast').textContent = 'ERR';
    }
}


function renderPendientes(targetListId) {
    const listElement = $(`#${targetListId}`);
    listElement.innerHTML = '';

    const term = $('#' + (targetListId === 'detailList' ? 'searchDetail' : 'searchPend')).value.trim().toLowerCase();
    const filteredData = appState.pendingPallets.filter(it =>
        it.Cliente.toLowerCase().includes(term)
    );

    if (!filteredData.length) {
        listElement.innerHTML = '<div class="empty">No hay pallets pendientes.</div>';
        return;
    }

    filteredData.forEach(pallet => {
        const itemNode = $('#tplItem').content.firstElementChild.cloneNode(true);
        $('.client', itemNode).textContent = pallet.Cliente;
        $('.cantidad', itemNode).textContent = `Disponible: ${pallet.DisponibleParaTareas}`;

        const fechaIngreso = pallet.FechaHoraIngreso ? new Date(pallet.FechaHoraIngreso) : null;
        let estadoText = `Pendiente: ${pallet.DisponibleParaTareas}`;
        if (fechaIngreso && !isNaN(fechaIngreso.getTime())) {
            estadoText += ` (${fechaIngreso.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })} ${fechaIngreso.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' })})`;
        } else {
            estadoText += " (Fecha desconocida)";
        }
        
        const badgeContainer = itemNode.querySelector('.badge-container');
        if (badgeContainer) {
            badgeContainer.innerHTML = `<span class="badge">${estadoText}</span>`;
        }

        if (targetListId === 'detailList') {
            itemNode.dataset.palletEntradaId = pallet.PalletEntradaID;
            itemNode.dataset.cliente = pallet.Cliente;
            itemNode.dataset.disponible = pallet.DisponibleParaTareas;

            const btnGenerar = document.createElement('button');
            btnGenerar.textContent = "Generar tarea";
            btnGenerar.className = "primary";
            btnGenerar.addEventListener('click', () => {
                showTaskGenSection(pallet);
            });
            
            if (badgeContainer) {
                badgeContainer.appendChild(btnGenerar);
            }
        }

        listElement.appendChild(itemNode);
    });
}

async function fetchTasks() {
    try {
        // *** CORRECCIÓN: Ruta a /api/tareas-descuento, sin barra final innecesaria ***
        const response = await fetch(`${API_URL}/tareas-descuento`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        appState.tasks = await response.json();
        renderTasks();
    } catch (error) {
        console.error('Error fetching tasks:', error);
        appState.tasks = [];
        renderTasks();
    }
}

function renderTasks() {
    const list = $('#taskList');
    list.innerHTML = '';
    
    if (!appState.tasks.length) {
        list.innerHTML = '<div class="empty">No hay tareas pendientes.</div>';
        return;
    }

    appState.tasks.forEach(tarea => {
        const taskNode = $('#tplTask').content.firstElementChild.cloneNode(true);
        $('.client', taskNode).textContent = `${tarea.Cliente} (Pasillo: ${tarea.Pasillo})`;
        $('.cantidad', taskNode).textContent = `Pendiente: ${tarea.CantidadPendienteDescontar} | Prioridad: ${tarea.Prioridad || 'N/A'}`;
        
        // --- LÓGICA PARA MOSTRAR ESTADO DE PROCESO Y DESHABILITAR BOTÓN ---
        const badgeContainer = taskNode.querySelector('.cantidad'); // Usaremos el mismo div que la cantidad para mostrar el badge
        if (tarea.EstadoProceso === 'EnProceso') {
            const badge = document.createElement('span');
            badge.textContent = `En proceso por: ${tarea.UsuarioProcesando || 'Alguien'}`;
            badge.className = "badge en-proceso-alerta"; // Estilo para indicar "en proceso"
            badgeContainer.appendChild(badge);

            // Deshabilitar el botón "Descontar" si está en proceso por otro usuario
            const btnTask = taskNode.querySelector('.btnTask');
            if (btnTask) {
                btnTask.disabled = true;
                btnTask.style.opacity = '0.6'; // Un poco de transparencia para indicar que está deshabilitado visualmente
            }
        }
        // --- FIN LÓGICA ESTADO PROCESO ---

        // El botón de Cancelar (desbloquear) sólo debería ser visible/activo si el usuario actual es quien bloqueó la tarea.
        // Para simplificar, lo hacemos siempre visible pero la lógica de desbloqueo podría ser más restrictiva.
        const btnCancel = taskNode.querySelector('.item > div:last-child > button:last-child'); 

        taskNode.dataset.taskId = tarea.ID;
        taskNode.dataset.cliente = tarea.Cliente;
        taskNode.dataset.cantidadPendiente = tarea.CantidadPendienteDescontar;
        taskNode.dataset.pasillo = tarea.Pasillo;

        // El botón "Descontar" ahora primero intenta bloquear la tarea
        const btnTask = taskNode.querySelector('.btnTask');
        if (btnTask) {
            btnTask.addEventListener('click', async (event) => { // Hacemos la función async para poder usar await
                // Asegurarse que el botón no esté deshabilitado antes de continuar
                if (btnTask.disabled) {
                    alert("Esta tarea ya está siendo procesada por otro usuario.");
                    return;
                }

                // Intentamos bloquear la tarea
                try {
                    // Aquí deberíamos obtener el nombre del usuario actual (ej. de un login)
                    // Por ahora, lo simulamos con prompt. Reemplaza esto con tu lógica de autenticación.
                    const usuarioActual = prompt("Introduce tu nombre de usuario para iniciar el proceso:");
                    if (!usuarioActual) {
                        alert("No se pudo iniciar el proceso sin un nombre de usuario.");
                        return;
                    }

                    const blockResponse = await fetch(`${API_URL}/tareas-descuento/${tarea.ID}/bloquear`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usuario: usuarioActual })
                    });

                    const blockResult = await blockResponse.json();

                    if (!blockResponse.ok) {
                        alert(blockResult.message || `Error al bloquear la tarea: ${blockResponse.status}`);
                        return; // No continuar si el bloqueo falla
                    }

                    // Si el bloqueo fue exitoso, procedemos a mostrar la sección de descuento
                    handleTaskButtonClick(event); // Llama a la función original para mostrar la sección de descuento
                } catch (error) {
                    console.error("Error al intentar bloquear la tarea:", error);
                    alert(`Error al bloquear la tarea: ${error.message}`);
                }
            });
        }

        // El botón "Cancelar" ahora llama a la función de desbloqueo
        if (btnCancel) {
            btnCancel.addEventListener('click', async () => {
                // Si la tarea está en proceso por otro usuario, no debería ser cancelable por este.
                // Esto se maneja principalmente en el backend, pero una confirmación es buena.
                if (!confirm(`¿Estás seguro de que deseas cancelar esta operación y desbloquear la tarea ${tarea.ID} para otros usuarios?`)) {
                    return; 
                }
                
                try {
                    // Pedir el nombre del usuario que desbloquea
                    const usuarioActual = prompt("Introduce tu nombre de usuario para desbloquear la tarea:");
                    if (!usuarioActual) {
                        alert("No se pudo desbloquear la tarea sin un nombre de usuario.");
                        return;
                    }

                    const response = await fetch(`${API_URL}/tareas-descuento/${tarea.ID}/desbloquear`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usuario: usuarioActual })
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || `HTTP error! status: ${response.status}`);
                    }

                    alert(`¡Éxito! ${result.message || 'Tarea desbloqueada.'}`);

                    fetchTasks(); // Recargar la lista para reflejar el cambio
                } catch (error) {
                    console.error('Error al desbloquear tarea:', error);
                    alert(`Error al desbloquear tarea: ${error.message}`);
                }
            });
        }    // **AÑADIR AQUÍ EL NUEVO BOTÓN DE ELIMINAR**
        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.className = 'ghost danger'; // Clase para estilo rojo
        btnEliminar.style.borderColor = 'var(--danger)'; // Borde rojo
        btnEliminar.style.color = 'var(--danger)'; // Texto rojo
        btnEliminar.onclick = async () => {
            if (!confirm(`¿Estás seguro de que deseas ELIMINAR esta tarea ${tarea.ID}? Esta acción no se puede deshacer.`)) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/tareas-descuento/${tarea.ID}`, { // Ruta DELETE
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `HTTP error! status: ${response.status}`);
                }

                alert(`¡Éxito! ${result.message || 'Tarea eliminada.'}`);
                fetchTasks(); // Refrescar lista
                fetchPendientes('pendingList'); // Refrescar otras listas
                fetchPendientes('detailList');
                fetchStatus(); // Refrescar KPIs
            } catch (error) {
                console.error('Error al eliminar tarea:', error);
                alert(`Error al eliminar tarea: ${error.message}`);
            }
        };

        // Añadir el botón de eliminar al contenedor de botones
        const buttonContainer = taskNode.querySelector('.item > div:last-child');
        if (buttonContainer) {
            buttonContainer.appendChild(btnEliminar);
        } else {
            console.error("No se encontró el contenedor de botones para añadir el botón Eliminar.");
        }


        list.appendChild(taskNode);
    });
}

// --- SECCIONES DE INTERACCIÓN ESPECÍFICA ---
function showTaskGenSection(pallet) {
    if (!pallet || !pallet.PalletEntradaID || !pallet.Cliente || typeof pallet.DisponibleParaTareas === 'undefined') {
        console.error("Error: Se intentó mostrar la sección de generación de tarea con datos de pallet inválidos.", pallet);
        alert("Error interno al seleccionar el pallet. Por favor, intenta de nuevo.");
        return;
    }
    
    appState.currentPalletForTask = pallet;
    $('#detailList').style.display = 'none';
    $('#taskGenSection').style.display = 'block';
    $('#currentPalletClient').textContent = pallet.Cliente;
    $('#taskCantidad').max = pallet.DisponibleParaTareas;
    $('#taskCantidad').value = pallet.DisponibleParaTareas;
    $('#taskPasillo').value = '';
    $('#taskGenInfo').textContent = `Pallet ID: ${pallet.PalletEntradaID}. Disponible para esta tarea: ${pallet.DisponibleParaTareas}`;
}

function hideTaskGenSection() {
    $('#taskGenSection').style.display = 'none';
    $('#detailList').style.display = 'grid';
    $('#formTaskGen').reset();
    appState.currentPalletForTask = null;
}

function handleTaskButtonClick(event) { // Esta función ahora está diseñada para ser llamada DESPUÉS de bloquear la tarea
    const clickedButton = event.target;
    const taskItemNode = clickedButton.closest('.item');

    if (!taskItemNode) {
        console.error("Error: No se pudo encontrar el elemento contenedor del item de la tarea.");
        alert("Error interno al seleccionar la tarea. Por favor, inténtalo de nuevo.");
        return;
    }

    const taskId = taskItemNode.dataset.taskId;
    const cantidadPendiente = parseInt(taskItemNode.dataset.cantidadPendiente);
    const cliente = taskItemNode.dataset.cliente;
    const pasillo = taskItemNode.dataset.pasillo || 'N/A';

    if (!taskId || isNaN(parseInt(taskId))) {
        console.error("Error: El taskId no es válido en el elemento contenedor.");
        alert("No se pudo identificar la tarea seleccionada. Por favor, inténtalo de nuevo.");
        return;
    }
    
    appState.currentTaskToDiscount = {
        id: taskId,
        cliente: cliente,
        cantidadPendiente: cantidadPendiente
    };

    $('#discountSection').style.display = 'block';
    $('#currentTaskClient').textContent = `${cliente} (Pasillo: ${pasillo})`;
    $('#discountCantidad').max = cantidadPendiente;
    $('#discountCantidad').value = cantidadPendiente;
    $('#discountInfo').textContent = `Pendiente en tarea: ${cantidadPendiente}`;
}

function hideDiscountSection() {
    $('#discountSection').style.display = 'none';
    $('#formDiscount').reset();
    appState.currentTaskToDiscount = null;
    appState.currentPalletToDiscountDirectly = null;
}


// --- Eventos de los formularios y botones ---
const btns = document.querySelectorAll(".ghost2");

  // activar "Hoy" apenas carga la app
  document.getElementById("btnFechaHoy").classList.add("active");

  btns.forEach(btn => {
    btn.addEventListener("click", () => {
      // sacar "active" a todos
      btns.forEach(b => b.classList.remove("active"));
      // marcar el que fue clickeado
      btn.classList.add("active");
    });
  });

// Evento para el formulario de Ingreso de Pallet
$('#formAdd').addEventListener('submit', async e => {
    e.preventDefault();
    const cantidad = parseInt($('#cantidad').value.trim());
    const cliente = $('#cliente').value;
    const usuarioIngreso = $('#UsuarioIngreso').value.trim();

    if (isNaN(cantidad) || cantidad <= 0) {
        alert('Por favor, ingresa una cantidad válida.');
        return;
    }
    if (!cliente) {
        alert('Por favor, selecciona un comitente.');
        return;
    }
    if (!usuarioIngreso) {
        alert('El usuario de ingreso es requerido.');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/pendientes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cantidad, cliente, UsuarioIngreso: usuarioIngreso })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || `HTTP error! status: ${response.status}`);
        }

        alert(`¡Éxito! ${result.message || 'Pallet cargado.'}`);
        $('#formAdd').reset();
        fetchPendientes('pendingList');
        fetchPendientes('detailList');
        /*fetchStatus();*/
    } catch (error) {
        console.error('Error al agregar pallet:', error);
        alert(`Error al cargar pallet: ${error.message}`);
    }
});

// Evento para el formulario de Descontar Pallet
$('#formDiscount').addEventListener('submit', async e => {
    e.preventDefault();

    let url;
    let requestBody;

    // Validar que haya una tarea seleccionada
    if (!appState.currentTaskToDiscount || !appState.currentTaskToDiscount.id) {
        alert('No hay tarea seleccionada para descontar. Por favor, haz clic en "Descontar" sobre una tarea de la lista y asegúrate de que se haya bloqueado correctamente.');
        return;
    }

    const cantidadADescontar = parseInt($('#discountCantidad').value.trim());
    // **SOLICITAR USUARIO MANUALMENTE AQUÍ, JUSTO ANTES DE ENVIAR LA PETICIÓN**
    const usuarioActual = prompt("Introduce tu nombre de usuario para realizar el descuento:");

    // Validaciones de usuario y cantidad
    if (isNaN(cantidadADescontar) || cantidadADescontar <= 0) {
        alert('Por favor, ingresa una cantidad válida a descontar.');
        return;
    }
    if (!usuarioActual || usuarioActual.trim() === "") { // Validamos que el usuario no esté vacío
        alert('Se requiere un nombre de usuario válido para realizar el descuento.');
        return;
    }

    // Construcción del requestBody incluyendo el usuario
    url = `/api/descontar-pallet`;
    requestBody = {
        tareaId: appState.currentTaskToDiscount.id,
        cantidadADescontar: cantidadADescontar,
        usuario: usuarioActual.trim() // Envía el usuario ingresado manualmente
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || `HTTP error! status: ${response.status}`);
        }

        alert(`¡Éxito! ${result.message || 'Pallet descontado de la tarea.'}`);
        hideDiscountSection();
        fetchTasks();
        fetchPendientes('pendingList');
        fetchPendientes('detailList');
        /*fetchStatus();*/
    } catch (error) {
        console.error('Error al descontar pallet:', error);
        alert(`Error al descontar pallet: ${error.message}`);
    }
});
// Evento para el formulario de Generar Tarea
$('#formTaskGen').addEventListener('submit', async e => {
    e.preventDefault();

    if (!appState.currentPalletForTask || !appState.currentPalletForTask.PalletEntradaID || !appState.currentPalletForTask.Cliente) {
        console.error('Error: appState.currentPalletForTask está incompleto o no está definido.', appState.currentPalletForTask);
        alert('No se ha podido identificar el pallet para generar la tarea. Por favor, selecciona un pallet de la lista anterior.');
        $('#taskGenSection').style.display = 'none';
        $('#detailList').style.display = 'grid';
        return;
    }

    const cantidad = parseInt($('#taskCantidad').value.trim());
    let pasillo = $('#taskPasillo').value.trim();
    const prioridad = $('#prioridad').value; // Capturamos la prioridad del nuevo select

    if (isNaN(cantidad) || cantidad <= 0) {
        alert('Por favor, ingresa una cantidad válida mayor a cero.');
        return;
    }
    
    if (!pasillo) {
        alert('El campo Pasillo es requerido.');
        return;
    }
    // Agregamos validación para la prioridad
    if (!prioridad) {
        alert('Por favor, selecciona una prioridad.');
        return;
    }


    try {
        const response = await fetch(`${API_URL}/tareas-descuento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                PalletEntradaID: appState.currentPalletForTask.PalletEntradaID,
                cliente: appState.currentPalletForTask.Cliente,
                cantidad: cantidad,
                pasillo: pasillo,
                prioridad: prioridad // <-- Enviamos la prioridad seleccionada
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || `HTTP error! status: ${response.status}`);
        }

        alert(`¡Éxito! ${result.message || 'Tarea generada.'}`);
        hideTaskGenSection();
        fetchPendientes('pendingList');
        fetchPendientes('detailList');
        fetchTasks();
        /*fetchStatus();*/
    } catch (error) {
        console.error('Error al generar tarea:', error);
        alert(`Error al generar tarea: ${error.message}`);
    }
});

// --- LÓGICA DE NAVEGACIÓN Y EVENTOS GLOBALES ---

// Función para obtener la ventana guardada desde localStorage
function obtenerVentanaGuardada() {
    const ventanaGuardada = localStorage.getItem(STORAGE_KEY);
    // Validar que la ventana guardada sea una de las opciones válidas
    const ventanasValidas = ['ingreso-pallet', 'generar-tarea', 'descontar-pallet'];
    return ventanasValidas.includes(ventanaGuardada) ? ventanaGuardada : 'ingreso-pallet';
}

document.addEventListener('DOMContentLoaded', () => {
    // Ocultar todas las ventanas primero
    const ventanas = $$('.ventana');
    ventanas.forEach(ventana => {
        ventana.classList.remove('visible');
    });
    
    // Mostrar la ventana guardada o la de ingreso por defecto
    const ventanaInicial = obtenerVentanaGuardada();
    mostrarVentana(ventanaInicial);
    
    // Cargar datos iniciales
    fetchStatus(); // Inicialmente, se carga el acumulado (cuando no hay fecha seleccionada)
    fetchTasks();
    fetchPendientes('pendingList'); // Cargar la lista de la primera ventana

    // Configurar fechas para el filtro de Excel y KPIs
    configurarFechasFiltro();
    // --- ACTIVAR BOTÓN "HOY" Y PONER FECHA ACTUAL AL INICIO ---
    if (btnFechaHoy && fechaInicioInput) {
        const hoy = new Date();
        const formatearFecha = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const fechaActual = formatearFecha(hoy);
        fechaInicioInput.value = fechaActual; // poner fecha actual en el input
        btnFechaHoy.classList.add('active');  // marcar botón como activo
        fetchStatus(fechaActual);             // actualizar KPIs para hoy
    } else {
        // Si por alguna razón no hay input, mostrar acumulado
        fetchStatus();
    }
    // Refrescar datos cada 1 minuto
    setInterval(() => {
        // Al refrescar, siempre se llama sin fecha si el input está vacío para mostrar acumulado.
        // Si hay una fecha seleccionada, el listener del input de fecha se encargará de actualizar los KPIs.
        fetchStatus(fechaInicioInput.value || null); 
        fetchTasks();
        // Solo refrescar la lista activa para no saturar
        const ventanaActiva = obtenerVentanaGuardada();
        if (ventanaActiva === 'ingreso-pallet') {
            fetchPendientes('pendingList');
        } else if (ventanaActiva === 'generar-tarea') {
            fetchPendientes('detailList');
        } else if (ventanaActiva === 'descontar-pallet') {
            fetchTasks();
        }
    }, 60000);
});

// Eventos para los botones de navegación
document.querySelectorAll('nav button[data-target]').forEach(button => {
    button.addEventListener('click', () => {
        const targetId = button.dataset.target;
        mostrarVentana(targetId);
    });
});

// --- FUNCIONES PARA FILTRO DE FECHA EN EL FRONTEND ---
function configurarFechasFiltro() {
    const hoy = new Date();
    const fechaInicioInput = document.getElementById('fechaInicioFiltro'); // Usaremos este input para ambos filtros (KPIs y Excel)

    // Formatear fecha para input type="date" (YYYY-MM-DD)
    const formatearFecha = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // Establecer fecha de hoy por defecto en el input
    if (fechaInicioInput) {
        fechaInicioInput.value = formatearFecha(hoy);
    }
}

// --- EVENTOS PARA LOS BOTONES DE FECHA ---
const descargarExcelBtn = document.getElementById('descargarExcelBtn');
const btnFechaHoy = document.getElementById('btnFechaHoy');
const btnLimpiarFecha = document.getElementById('btnAcumulado'); // Este es el botón "Acumulado"
const fechaInicioInput = document.getElementById('fechaInicioFiltro'); // Este es el selector de fecha principal

// Función para descargar Excel
async function descargarExcel(fechaInicio, fechaFin) {
    let url = '/descargar-movimientos';
    const params = [];
    if (fechaInicio) params.push(`fechaInicio=${encodeURIComponent(fechaInicio)}`);
    if (fechaFin) params.push(`fechaFin=${encodeURIComponent(fechaFin)}`);
    if (params.length > 0) url += `?${params.join('&')}`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Error al descargar: ${errorData.message || response.statusText}`);
            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
        const blob = await response.blob();
        const link = document.createElement('a');
        const urlBlob = window.URL.createObjectURL(blob);
        link.href = urlBlob;
        // Crear un nombre de archivo más dinámico
        const nombreArchivo = `movimientos_${fechaInicio || 'inicio'}_${fechaFin || 'fin'}.csv`;
        link.download = nombreArchivo;
        link.click();
        window.URL.revokeObjectURL(urlBlob);
    } catch (error) {
        console.error("Error en descargarExcel:", error);
        // El alert ya se mostró si hubo un error específico de fetch
    }
}

// Evento para el botón de descargar Excel
if (descargarExcelBtn) {
    descargarExcelBtn.addEventListener('click', () => {
        const fechaInicio = fechaInicioInput.value;
        // Para la descarga, usaremos la misma fecha para inicio y fin si solo se selecciona una.
        const fechaFin = fechaInicioInput.value;
        descargarExcel(fechaInicio, fechaFin);
    });
}

// Evento para el botón "Hoy"
if (btnFechaHoy) {
    btnFechaHoy.addEventListener('click', () => {
        const hoy = new Date();
        const formatearFecha = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const fechaActual = formatearFecha(hoy);
        fechaInicioInput.value = fechaActual; // Actualizar el input para que refleje la selección
        fetchStatus(fechaActual); // Actualizar KPIs para hoy
    });
}

// Evento para el botón "Acumulado"
if (btnLimpiarFecha) {
    btnLimpiarFecha.addEventListener('click', () => {
        fechaInicioInput.value = ''; // Limpiar el input de fecha
        fetchStatus(); // Volver a cargar los KPIs acumulados
    });
}

// Evento para el input de fecha para actualizar KPIs
if (fechaInicioInput) {
    fechaInicioInput.addEventListener('change', () => {
        const selectedDate = fechaInicioInput.value;
        // Si se ha seleccionado una fecha, actualizamos los KPIs. Si está vacío, fetchStatus se encargará del acumulado.
        fetchStatus(selectedDate || null); 
    });
}
</script>
</body>
</html>
